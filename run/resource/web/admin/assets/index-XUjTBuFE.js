var Y=Object.defineProperty,j=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var B=(e,s,t)=>s in e?Y(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,v=(e,s)=>{for(var t in s||(s={}))G.call(s,t)&&B(e,t,s[t]);if($)for(var t of $(s))H.call(s,t)&&B(e,t,s[t]);return e},T=(e,s)=>j(e,W(s));import{o as R,j as O,bI as m,aa as P,e as J,bJ as X,h as F,$ as Z}from"./entry/index-CMepwc5X-1716790511191.js";import{Q as A,W as N,bi as M,O as Q,U as q,n as K,ah as ee,bj as te,Z as z,aa as se}from"./antd-BRjMhd0C.js";import{d as x,f as oe,c as L,u as d,w as ae,_ as u,a8 as _,a9 as c,a2 as E,$ as y,ab as U,k as p,a0 as D,G as S,a1 as w,ac as I,F as V,V as ne,ak as le,aa as h}from"./vue-Bw3NQgLF.js";const ie={class:"title"},re={key:0,class:"extra"},ce={key:1},ue={key:0,class:"description"},de={class:"datetime"},pe=x({__name:"NoticeList",props:{list:{type:Array,default:()=>[]},pageSize:{type:[Boolean,Number],default:5},currentPage:{type:Number,default:1},titleRows:{type:Number,default:1},descRows:{type:Number,default:2},onTitleClick:{type:Function}},emits:["update:currentPage"],setup(e,{emit:s}){const t=e,l=s,{prefixCls:o}=R("header-notify-list"),i=oe(t.currentPage||1),r=L(()=>{const{pageSize:a,list:g}=t;if(a===!1)return[];let n=A(a)?a:5;return g.slice(n*(d(i)-1),n*d(i))});ae(()=>t.currentPage,a=>{i.value=a});const b=L(()=>{const{list:a,pageSize:g}=t,n=A(g)?g:Number(g)&&5;return n>0&&a&&a.length>n?{total:a.length,pageSize:n,current:d(i),onChange(C){i.value=C,l("update:currentPage",C)}}:!1});function f(a){t.onTitleClick&&t.onTitleClick(a)}return(a,g)=>(u(),_(d(N),{class:E(d(o)),bordered:"",pagination:b.value},{default:c(()=>[(u(!0),y(V,null,U(r.value,n=>(u(),_(d(N).Item,{key:n.id,class:"list-item"},{default:c(()=>[p(d(N).Item.Meta,null,{title:c(()=>[D("div",ie,[p(d(M).Paragraph,{onClick:C=>f(n),delete:!!n.titleDelete,ellipsis:e.titleRows&&e.titleRows>0?{rows:e.titleRows,tooltip:!!n.title}:!1,content:n.title},null,8,["onClick","delete","ellipsis","content"]),n.extra?(u(),y("div",re,[p(d(Q),{class:"tag",color:n.color},{default:c(()=>[S(w(n.extra),1)]),_:2},1032,["color"])])):I("",!0)])]),avatar:c(()=>[n.avatar?(u(),_(d(q),{key:0,class:"avatar",src:n.avatar},null,8,["src"])):(u(),y("span",ce,w(n.avatar),1))]),description:c(()=>[D("div",null,[n.description?(u(),y("div",ue,[p(d(M).Paragraph,{ellipsis:e.descRows&&e.descRows>0?{rows:e.descRows,tooltip:!!n.description}:!1,content:n.description},null,8,["ellipsis","content"])])):I("",!0),D("div",de,w(n.datetime),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1},8,["class","pagination"]))}}),fe=O(pe,[["__scopeId","data-v-3d9c14d4"]]),ge=[{key:"1",name:"通知",list:[]},{key:"2",name:"消息",list:[]},{key:"3",name:"待办",list:[]}],{notification:be}=F(),ke=ne("notify",{state:()=>({listData:ge}),getters:{count(e){var o;const t=((o=m().userInfo)==null?void 0:o.userId)||0;let l=0;for(let i=0;i<e.listData.length;i++)l+=e.listData[i].list.filter(r=>r.uid===t).length;return l},unreadCount(e){var o;const t=((o=m().userInfo)==null?void 0:o.userId)||0;let l=0;for(let i=0;i<e.listData.length;i++)l+=e.listData[i].list.filter(r=>r.uid===t&&!r.titleDelete).length;return l},userMessageList(e){var l;const t=((l=m().userInfo)==null?void 0:l.userId)||0;return e.listData.map(o=>T(v({},o),{list:o.list.filter(i=>i.uid===t)}))}},actions:{listeningMessage(){const{websocketEnable:e}=P();if(!e){console.log("当前未开启websocket.");return}const{apiUrl:s,clientId:t}=P();let l=String(s);Z(s)||(l=`${window.location.protocol}//${window.location.host}${s}`);let o=`${l}/resource/websocket?clientId=${t}&Authorization=Bearer ${J()}`;window.location.protocol.includes("https")?o=o.replace("https://","wss://"):o=o.replace("http://","ws://"),X(o,{autoReconnect:{retries:3,delay:1e3,onFailed(){console.log("websocket重连失败.")}},heartbeat:{message:JSON.stringify({type:"ping"}),interval:1e4,pongTimeout:2e3},onConnected(){console.log("websocket已经连接")},onDisconnected(){console.log("websocket已经断开")},onMessage:(i,r)=>{var a;console.log("接收到消息: "+r.data);const b="notify-"+this.listData[0].list.length,f=((a=m().userInfo)==null?void 0:a.userId)||0;this.listData[0].list.unshift({id:b,uid:f,avatar:"https://gw.alipayobjects.com/zos/rmsportal/ThXAXghbEsBCCSDihZxY.png",title:r.data,description:"",datetime:K().format("YYYY-MM-DD HH:mm:ss"),type:"1"}),setTimeout(()=>{be.info({message:"收到新消息",description:r.data,duration:3})},500)}})},clearAll(){var t;const s=((t=m().userInfo)==null?void 0:t.userId)||0;this.listData=this.listData.map(l=>T(v({},l),{list:l.list.filter(o=>o.uid!==s)}))},readAll(){var t;const s=((t=m().userInfo)==null?void 0:t.userId)||0;for(let l=0;l<this.listData.length;l++)this.listData[l].list.forEach(o=>{o.uid===s&&(o.read=!0,o.titleDelete=!0)})}},persist:!0}),he=x({components:{Popover:ee,BellOutlined:te,Tabs:z,TabPane:z.TabPane,Badge:se,NoticeList:fe},setup(){const{prefixCls:e}=R("header-notify"),{createConfirm:s}=F(),t=ke(),{count:l,unreadCount:o,userMessageList:i}=le(t);t.listeningMessage();function r(a){s({iconType:"info",title:"消息通知",content:`${a.title}<br/>
                    ${a.datetime}`,okText:"已读",okButtonProps:{disabled:a.titleDelete},onOk(){a.titleDelete||(a.titleDelete=!0)}}),console.log(a),console.log("你点击了通知, ID="+a.id)}function b(){s({iconType:"warning",title:"提示",content:"确定要清空所有消息吗?",onOk(){t.clearAll()}})}function f(){s({iconType:"warning",title:"提示",content:"确定要已读所有消息吗?",onOk(){t.readAll()}})}return{prefixCls:e,userMessageList:i,count:l,unreadCount:o,onNoticeClick:r,numberStyle:{fontSize:"10px"},clearAllMessage:b,readAllMessage:f}}}),ye={key:0},me={class:"w-full"};function _e(e,s,t,l,o,i){const r=h("BellOutlined"),b=h("Badge"),f=h("NoticeList"),a=h("TabPane"),g=h("Tabs"),n=h("a-button"),C=h("Popover");return u(),y("div",{class:E(e.prefixCls)},[p(C,{title:"",trigger:"click",overlayClassName:`${e.prefixCls}__overlay`},{content:c(()=>[p(g,null,{default:c(()=>[(u(!0),y(V,null,U(e.userMessageList,k=>(u(),_(a,{key:k.key},{tab:c(()=>[S(w(k.name)+" ",1),k.list.length!==0?(u(),y("span",ye,"("+w(k.list.length)+")",1)):I("",!0)]),default:c(()=>[k.key==="1"?(u(),_(f,{key:0,list:k.list,onTitleClick:e.onNoticeClick},null,8,["list","onTitleClick"])):(u(),_(f,{key:1,list:k.list},null,8,["list"]))]),_:2},1024))),128))]),_:1}),D("div",me,[p(n,{type:"success",block:"",class:"btn-clear-all",onClick:e.readAllMessage,disabled:e.unreadCount===0},{default:c(()=>[S("已读全部消息")]),_:1},8,["onClick","disabled"]),p(n,{type:"error",block:"",class:"btn-clear-all",onClick:e.clearAllMessage,disabled:e.count===0},{default:c(()=>[S("清空全部消息")]),_:1},8,["onClick","disabled"])])]),default:c(()=>[p(b,{count:e.unreadCount,offset:[0,15],size:"small",numberStyle:e.numberStyle},{default:c(()=>[p(r)]),_:1},8,["count","numberStyle"])]),_:1},8,["overlayClassName"])],2)}const ve=O(he,[["render",_e]]);export{ve as default};
