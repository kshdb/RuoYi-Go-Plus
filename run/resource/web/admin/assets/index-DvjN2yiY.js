var j=Object.defineProperty,W=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var I=(e,s,t)=>s in e?j(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t,w=(e,s)=>{for(var t in s||(s={}))G.call(s,t)&&I(e,t,s[t]);if(B)for(var t of B(s))H.call(s,t)&&I(e,t,s[t]);return e},T=(e,s)=>W(e,Z(s));import{q as R,l as F,bS as m,ab as A,e as X,bT as q,h as O,bB as J}from"./entry/index-BbJQUQ84-1718268303552.js";import{Q as P,W as N,bm as M,A as Q,U as K,n as ee,ae as te,bn as se,Z as z,a7 as ae}from"./antd-DMGzOvrA.js";import{d as x,f as E,c as L,u as p,w as ne,Z as d,a8 as _,a9 as u,a1 as U,_ as k,aa as V,k as f,$ as S,G as D,a0 as v,ab as $,F as Y,V as oe,aj as le,a7 as h}from"./vue-Cw15aJ-2.js";const ie={class:"title"},re={key:0,class:"extra"},ce={key:1},ue={key:0,class:"description"},de={class:"datetime"},pe=x({__name:"NoticeList",props:{list:{type:Array,default:()=>[]},pageSize:{type:[Boolean,Number],default:5},currentPage:{type:Number,default:1},titleRows:{type:Number,default:1},descRows:{type:Number,default:2},onTitleClick:{type:Function}},emits:["update:currentPage"],setup(e,{emit:s}){const t=e,o=s,{prefixCls:a}=R("header-notify-list"),l=E(t.currentPage||1),r=L(()=>{const{pageSize:i,list:c}=t;if(i===!1)return[];let n=P(i)?i:5;return c.slice(n*(p(l)-1),n*p(l))});ne(()=>t.currentPage,i=>{l.value=i});const y=L(()=>{const{list:i,pageSize:c}=t,n=P(c)?c:Number(c)&&5;return n>0&&i&&i.length>n?{total:i.length,pageSize:n,current:p(l),onChange(C){l.value=C,o("update:currentPage",C)}}:!1});function g(i){t.onTitleClick&&t.onTitleClick(i)}return(i,c)=>(d(),_(p(N),{class:U(p(a)),bordered:"",pagination:y.value},{default:u(()=>[(d(!0),k(Y,null,V(r.value,n=>(d(),_(p(N).Item,{key:n.id,class:"list-item"},{default:u(()=>[f(p(N).Item.Meta,null,{title:u(()=>[S("div",ie,[f(p(M).Paragraph,{onClick:C=>g(n),delete:!!n.titleDelete,ellipsis:e.titleRows&&e.titleRows>0?{rows:e.titleRows,tooltip:!!n.title}:!1,content:n.title},null,8,["onClick","delete","ellipsis","content"]),n.extra?(d(),k("div",re,[f(p(Q),{class:"tag",color:n.color},{default:u(()=>[D(v(n.extra),1)]),_:2},1032,["color"])])):$("",!0)])]),avatar:u(()=>[n.avatar?(d(),_(p(K),{key:0,class:"avatar",src:n.avatar},null,8,["src"])):(d(),k("span",ce,v(n.avatar),1))]),description:u(()=>[S("div",null,[n.description?(d(),k("div",ue,[f(p(M).Paragraph,{ellipsis:e.descRows&&e.descRows>0?{rows:e.descRows,tooltip:!!n.description}:!1,content:n.description},null,8,["ellipsis","content"])])):$("",!0),S("div",de,v(n.datetime),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1},8,["class","pagination"]))}}),fe=F(pe,[["__scopeId","data-v-3d9c14d4"]]),ge=[{key:"1",name:"通知",list:[]},{key:"2",name:"消息",list:[]},{key:"3",name:"待办",list:[]}],{notification:ye}=O(),be=oe("notify",{state:()=>({listData:ge}),getters:{count(e){var a;const t=((a=m().userInfo)==null?void 0:a.userId)||0;let o=0;for(let l=0;l<e.listData.length;l++)o+=e.listData[l].list.filter(r=>r.uid===t).length;return o},unreadCount(e){var a;const t=((a=m().userInfo)==null?void 0:a.userId)||0;let o=0;for(let l=0;l<e.listData.length;l++)o+=e.listData[l].list.filter(r=>r.uid===t&&!r.titleDelete).length;return o},userMessageList(e){var o;const t=((o=m().userInfo)==null?void 0:o.userId)||0;return e.listData.map(a=>T(w({},a),{list:a.list.filter(l=>l.uid===t)}))}},actions:{listeningMessage(){const{websocketEnable:e}=A();if(!e)return;const{apiUrl:s,clientId:t}=A();let o=String(s);J(s)||(o=`${window.location.protocol}//${window.location.host}${s}`);let a=`${o}/resource/websocket?clientId=${t}&Authorization=Bearer ${X()}`;window.location.protocol.includes("https")?a=a.replace("https://","wss://"):a=a.replace("http://","ws://"),q(a,{autoReconnect:{retries:3,delay:1e3,onFailed(){}},heartbeat:{message:JSON.stringify({type:"ping"}),interval:1e4,pongTimeout:2e3},onConnected(){},onDisconnected(){},onMessage:(l,r)=>{var i;const y="notify-"+this.listData[0].list.length,g=((i=m().userInfo)==null?void 0:i.userId)||0;this.listData[0].list.unshift({id:y,uid:g,avatar:"https://gw.alipayobjects.com/zos/rmsportal/ThXAXghbEsBCCSDihZxY.png",title:r.data,description:"",datetime:ee().format("YYYY-MM-DD HH:mm:ss"),type:"1"}),setTimeout(()=>{ye.info({message:"收到新消息",description:r.data,duration:3})},500)}})},clearAll(){var t;const s=((t=m().userInfo)==null?void 0:t.userId)||0;this.listData=this.listData.map(o=>T(w({},o),{list:o.list.filter(a=>a.uid!==s)}))},readAll(){var t;const s=((t=m().userInfo)==null?void 0:t.userId)||0;for(let o=0;o<this.listData.length;o++)this.listData[o].list.forEach(a=>{a.uid===s&&(a.read=!0,a.titleDelete=!0)})}},persist:!0}),he=x({components:{Popover:te,BellOutlined:se,Tabs:z,TabPane:z.TabPane,Badge:ae,NoticeList:fe},setup(){const{prefixCls:e}=R("header-notify"),{createConfirm:s}=O(),t=be(),{count:o,unreadCount:a,userMessageList:l}=le(t);t.listeningMessage();const r=E(null);function y(c){r.value&&r.value.destroy(),r.value=s({iconType:"info",title:"消息通知",content:`${c.title}<br/>
                    ${c.datetime}`,okText:"已读",okButtonProps:{disabled:c.titleDelete},onOk(){c.titleDelete||(c.titleDelete=!0)}})}function g(){s({iconType:"warning",title:"提示",content:"确定要清空所有消息吗?",onOk(){t.clearAll()}})}function i(){s({iconType:"warning",title:"提示",content:"确定要已读所有消息吗?",onOk(){t.readAll()}})}return{prefixCls:e,userMessageList:l,count:o,unreadCount:a,onNoticeClick:y,numberStyle:{fontSize:"10px"},clearAllMessage:g,readAllMessage:i}}}),ke={key:0},me={class:"w-full"};function _e(e,s,t,o,a,l){const r=h("BellOutlined"),y=h("Badge"),g=h("NoticeList"),i=h("TabPane"),c=h("Tabs"),n=h("a-button"),C=h("Popover");return d(),k("div",{class:U(e.prefixCls)},[f(C,{title:"",trigger:"click",overlayClassName:`${e.prefixCls}__overlay`},{content:u(()=>[f(c,{centered:""},{default:u(()=>[(d(!0),k(Y,null,V(e.userMessageList,b=>(d(),_(i,{key:b.key},{tab:u(()=>[D(v(b.name)+" ",1),b.list.length!==0?(d(),k("span",ke,"("+v(b.list.length)+")",1)):$("",!0)]),default:u(()=>[b.key==="1"?(d(),_(g,{key:0,list:b.list,onTitleClick:e.onNoticeClick},null,8,["list","onTitleClick"])):(d(),_(g,{key:1,list:b.list},null,8,["list"]))]),_:2},1024))),128))]),_:1}),S("div",me,[f(n,{type:"success",block:"",class:"btn-clear-all",onClick:e.readAllMessage,disabled:e.unreadCount===0},{default:u(()=>[D("已读全部消息")]),_:1},8,["onClick","disabled"]),f(n,{type:"error",block:"",class:"btn-clear-all",onClick:e.clearAllMessage,disabled:e.count===0},{default:u(()=>[D("清空全部消息")]),_:1},8,["onClick","disabled"])])]),default:u(()=>[f(y,{count:e.unreadCount,offset:[0,15],size:"small",numberStyle:e.numberStyle},{default:u(()=>[f(r)]),_:1},8,["count","numberStyle"])]),_:1},8,["overlayClassName"])],2)}const we=F(he,[["render",_e]]);export{we as default};
