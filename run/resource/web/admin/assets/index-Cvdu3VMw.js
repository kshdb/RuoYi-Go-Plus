var E=(p,m,d)=>new Promise((b,M)=>{var s=g=>{try{c(d.next(g))}catch(v){M(v)}},_=g=>{try{c(d.throw(g))}catch(v){M(v)}},c=g=>g.done?b(g.value):Promise.resolve(g.value).then(s,_);c((d=d.apply(p,m)).next())});import{j as N,w as D}from"./entry/index-CMepwc5X-1716790511191.js";import{V as P,Z as q,M as j}from"./index-u_3lW7KD.js";import{a as U}from"./index-CU-vYa55.js";import{O as $,T as R,ad as X}from"./antd-BRjMhd0C.js";import{d as Z,f as y,o as H,aa as K,_ as C,$ as G,a0 as w,k as f,a9 as u,G as T,u as k,ac as O,a3 as A,a4 as F}from"./vue-Bw3NQgLF.js";const I=p=>(A("data-v-19137df8"),p=p(),F(),p),J={class:"bpmn-viewer w-full h-full"},Q={id:"toolbar",class:"flex flex-row justify-between items-center mb-24px"},W={key:0},Y=I(()=>w("span",null,"适应屏幕(居中)",-1)),ee=I(()=>w("span",null,"缩小视图",-1)),te=I(()=>w("span",null,"放大视图",-1)),ie=Z({__name:"index",props:{type:{type:String,default:"instanceId"},xml:{type:String,required:!1},instanceId:{type:String,required:!1}},setup(p){const m=p,d=y(),b=y(),M=y(""),s=y([]),_=y([]),c=y(1);H(()=>E(this,null,function*(){switch(d.value&&d.value.destroy(),d.value=new P({container:b.value,additionalModules:[{zoomScroll:["value",""]},q,j]}),m.type){case"instanceId":if(!m.instanceId){console.error("instanceId为空 无法加载");return}const a=yield U(m.instanceId);M.value=a.xml,s.value=a.taskList,_.value=a.historyList,yield g(a.xml);break;case"xml":if(!m.xml){console.error("xml为空 无法加载");return}yield g(m.xml);break}}));function g(a){return E(this,null,function*(){var e;try{yield(e=d.value)==null?void 0:e.importXML(a),B(),z(),v()}catch(l){console.log(l)}})}function v(){var l,t;const a=(l=d.value)==null?void 0:l.get("eventBus"),e=(t=d.value)==null?void 0:t.get("overlays");!a||!e||(a.on("element.hover",r=>{let i=_.value.find(o=>o.taskDefinitionKey===r.element.id);r.element.type==="bpmn:UserTask"&&i&&setTimeout(()=>{L(r,e,i)},10)}),a.on("element.out",()=>{e.clear()}))}function L(a,e,l){e.add(a.element.id,{position:{top:a.element.height,left:0},html:`<div class="verlays">
                    <p>审批人员: ${l.nickName||""}<p/>
                    <p>节点状态：${l.status||""}</p>
                    <p>开始时间：${l.startTime||""}</p>
                    <p>结束时间：${l.endTime||""}</p>
                    <p>审批耗时：${l.runDuration||""}</p>
                   </div>`})}function B(){var t,r,i,o;c.value=((t=d.value)==null?void 0:t.get("canvas").zoom("fit-viewport"))||1;const a=(r=document.querySelector(".bpmn-viewer .viewport"))==null?void 0:r.getBBox(),e=(i=d.value)==null?void 0:i.get("canvas").viewbox();if(!a||!e)return;const l={x:a.x+a.width/2-65,y:a.y+a.height/2};(o=d.value)==null||o.get("canvas").viewbox({x:l.x-e.width/2,y:l.y-e.height/2,width:e.width,height:e.height}),c.value=a.width/e.width*1.8}function S(a=!0){var e,l;c.value=((e=d.value)==null?void 0:e.get("canvas").zoom())||1,c.value+=a?.1:-.1,(l=d.value)==null||l.get("canvas").zoom(c.value)}function z(){var l;const a=(l=d.value)==null?void 0:l.get("canvas"),e=d.value._definitions.rootElements[0].flowElements;a&&V(e,a)}function V(a,e){const l=s.value.findLast(t=>t.completed===!1);if(l){const t=[];for(let r of a){if(r.id===l.key){t.push(r);break}t.push(r)}a=t}a.forEach(t=>{var r;if(t.$type==="bpmn:UserTask"){const i=s.value.find(o=>o.key===t.id);i&&(e.addMarker(t.id,i.completed?"highlight":"highlight-todo"),(r=t.outgoing)==null||r.forEach(o=>{const n=s.value.find(h=>h.key===o.targetRef.id);n?e.addMarker(o.id,n.completed?"highlight":"highlight-todo"):o.targetRef.$type==="bpmn:ExclusiveGateway"?(e.addMarker(o.id,i.completed?"highlight":"highlight-todo"),e.addMarker(o.targetRef.id,i.completed?"highlight":"highlight-todo"),o.targetRef.outgoing.forEach(h=>{x(h.id,h.targetRef.$type,h.targetRef.id,e,i.completed)})):o.targetRef.$type==="bpmn:ParallelGateway"?(e.addMarker(o.id,i.completed?"highlight":"highlight-todo"),e.addMarker(o.targetRef.id,i.completed?"highlight":"highlight-todo"),o.targetRef.outgoing.forEach(h=>{x(h.id,h.targetRef.$type,h.targetRef.id,e,i.completed)})):o.targetRef.$type==="bpmn:InclusiveGateway"&&(e.addMarker(o.id,i.completed?"highlight":"highlight-todo"),e.addMarker(o.targetRef.id,i.completed?"highlight":"highlight-todo"),o.targetRef.outgoing.forEach(h=>{x(h.id,h.targetRef.$type,h.targetRef.id,e,i.completed)}))}))}else if(t.$type==="bpmn:ExclusiveGateway")t.outgoing.forEach(i=>{const o=s.value.find(n=>n.key===i.targetRef.id);o&&e.addMarker(i.id,o.completed?"highlight":"highlight-todo")});else if(t.$type==="bpmn:ParallelGateway")t.outgoing.forEach(i=>{const o=s.value.find(n=>n.key===i.targetRef.id);o&&e.addMarker(i.id,o.completed?"highlight":"highlight-todo")});else if(t.$type==="bpmn:InclusiveGateway")t.outgoing.forEach(i=>{const o=s.value.find(n=>n.key===i.targetRef.id);o&&e.addMarker(i.id,o.completed?"highlight":"highlight-todo")});else if(t.$type==="bpmn:SubProcess"){const i=s.value.find(o=>o.key===t.id);i&&e.addMarker(t.id,i.completed?"highlight":"highlight-todo"),V(t.flowElements,e)}else if(t.$type==="bpmn:StartEvent")e.addMarker(t.id,"startEvent"),t.outgoing&&t.outgoing.forEach(i=>{s.value.find(n=>n.key===i.targetRef.id)&&(e.addMarker(i.id,"highlight"),e.addMarker(t.id,"highlight"))});else if(t.$type==="bpmn:EndEvent"){e.addMarker(t.id,"endEvent");const i=s.value.find(o=>o.key===t.id);if(i){e.addMarker(i.key,"highlight"),e.addMarker(t.id,"highlight");return}}})}function x(a,e,l,t,r){e==="bpmn:ExclusiveGateway"&&(t.addMarker(a,r?"highlight":"highlight-todo"),t.addMarker(l,r?"highlight":"highlight-todo")),e==="bpmn:ParallelGateway"&&(t.addMarker(a,r?"highlight":"highlight-todo"),t.addMarker(l,r?"highlight":"highlight-todo")),e==="bpmn:InclusiveGateway"&&(t.addMarker(a,r?"highlight":"highlight-todo"),t.addMarker(l,r?"highlight":"highlight-todo"))}return(a,e)=>{const l=K("a-button");return C(),G("div",J,[w("div",Q,[p.type==="instanceId"?(C(),G("div",W,[f(k($),{color:"gray"},{default:u(()=>[T("未完成")]),_:1}),f(k($),{color:"warning"},{default:u(()=>[T("进行中")]),_:1}),f(k($),{color:"green"},{default:u(()=>[T("已完成")]),_:1})])):O("",!0),f(k(X),null,{default:u(()=>[f(k(R),{placement:"bottom"},{title:u(()=>[Y]),default:u(()=>[f(l,{"pre-icon":"material-symbols:center-focus-strong-outline",onClick:B})]),_:1}),f(k(R),{placement:"bottom"},{title:u(()=>[ee]),default:u(()=>[f(l,{"pre-icon":"ooui:zoom-out",onClick:e[0]||(e[0]=t=>S(!1))})]),_:1}),f(k(R),{placement:"bottom"},{title:u(()=>[te]),default:u(()=>[f(l,{"pre-icon":"ooui:zoom-in",onClick:e[1]||(e[1]=t=>S(!0))})]),_:1})]),_:1})]),w("div",{ref_key:"containerRef",ref:b,class:"w-full h-full"},null,512)])}}}),oe=N(ie,[["__scopeId","data-v-19137df8"]]),ge=D(oe);export{ge as B};
